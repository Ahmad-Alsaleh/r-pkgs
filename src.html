<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 15 Compiled code | R Packages</title>
<meta name="author" content="Hadley Wickham">
<meta name="author" content="Jennifer Bryan">
<meta name="description" content="R is a high-level, expressive language. But that expressivity comes at a price: speed. That’s why incorporating a low-level, compiled language like C or C++ can powerfully complement your R code....">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="Chapter 15 Compiled code | R Packages">
<meta property="og:type" content="book">
<meta property="og:url" content="https://r-pkgs.org/src.html">
<meta property="og:image" content="https://r-pkgs.org/images/cover.png">
<meta property="og:description" content="R is a high-level, expressive language. But that expressivity comes at a price: speed. That’s why incorporating a low-level, compiled language like C or C++ can powerfully complement your R code....">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 15 Compiled code | R Packages">
<meta name="twitter:site" content="@hadley">
<meta name="twitter:description" content="R is a high-level, expressive language. But that expressivity comes at a price: speed. That’s why incorporating a low-level, compiled language like C or C++ can powerfully complement your R code....">
<meta name="twitter:image" content="https://r-pkgs.org/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141182576-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-141182576-1');
  </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R Packages</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome!</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li class="book-part">Getting started</li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="whole-game.html"><span class="header-section-number">2</span> The whole game</a></li>
<li><a class="" href="setup.html"><span class="header-section-number">3</span> System setup</a></li>
<li><a class="" href="package-structure-state.html"><span class="header-section-number">4</span> Package structure and state</a></li>
<li><a class="" href="workflows101.html"><span class="header-section-number">5</span> Fundamental development workflows</a></li>
<li><a class="" href="package-within.html"><span class="header-section-number">6</span> The package within</a></li>
<li class="book-part">Package components</li>
<li><a class="" href="r.html"><span class="header-section-number">7</span> R code</a></li>
<li><a class="" href="description.html"><span class="header-section-number">8</span> Package metadata</a></li>
<li><a class="" href="license.html"><span class="header-section-number">9</span> Licensing</a></li>
<li><a class="" href="man.html"><span class="header-section-number">10</span> Object documentation</a></li>
<li><a class="" href="vignettes.html"><span class="header-section-number">11</span> Vignettes: long-form documentation</a></li>
<li><a class="" href="tests.html"><span class="header-section-number">12</span> Testing</a></li>
<li><a class="" href="namespace.html"><span class="header-section-number">13</span> Namespace</a></li>
<li><a class="" href="data.html"><span class="header-section-number">14</span> External data</a></li>
<li><a class="active" href="src.html"><span class="header-section-number">15</span> Compiled code</a></li>
<li><a class="" href="inst.html"><span class="header-section-number">16</span> Installed files</a></li>
<li><a class="" href="misc.html"><span class="header-section-number">17</span> Other components</a></li>
<li class="book-part">Sharing with others</li>
<li><a class="" href="git.html"><span class="header-section-number">18</span> Git and GitHub</a></li>
<li><a class="" href="r-cmd-check.html"><span class="header-section-number">19</span> Automated checking</a></li>
<li><a class="" href="release.html"><span class="header-section-number">20</span> Releasing a package</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/r-pkgs">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="src" class="section level1">
<h1>
<span class="header-section-number">15</span> Compiled code<a class="anchor" aria-label="anchor" href="#src"><i class="fas fa-link"></i></a>
</h1>
<p>R is a high-level, expressive language. But that expressivity comes at a price: speed. That’s why incorporating a low-level, compiled language like C or C++ can powerfully complement your R code. While C and C++ often require more lines of code (and more careful thought) to solve the same problem, they can be orders of magnitude faster than R.</p>
<p>Unfortunately, teaching you how to program in C or C++ is beyond the scope of the book. If you’d like to learn, I recommend starting with C++ and the Rcpp package. Rcpp makes it easy to connect C++ to R. I’d also recommend using RStudio because it has many tools that facilitate the entire process. Start by reading <a href="https://adv-r.hadley.nz/rcpp.html">“Rewriting R code in C++”</a>, a freely available book chapter from <a href="https://amzn.to/2WoabjB">Advanced R</a>: it gently introduces the language by translating examples of familiar R code into C++. Next, check out the <a href="http://www.rcpp.org/book">Rcpp book</a> and the other resources listed in <a href="https://adv-r.hadley.nz/rcpp.html#rcpp-more">learning more</a>.</p>
<div id="cpp" class="section level2">
<h2>
<span class="header-section-number">15.1</span> C++<a class="anchor" aria-label="anchor" href="#cpp"><i class="fas fa-link"></i></a>
</h2>
<p>To set up your package with Rcpp, run:</p>
<div class="sourceCode" id="cb259"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_rcpp.html">use_rcpp</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This will:</p>
<ul>
<li><p>Create a <code>src/</code> directory to hold your <code>.cpp</code> files.</p></li>
<li><p>Add <code>Rcpp</code> to the <code>LinkingTo</code> and <code>Imports</code> fields in the <code>DESCRIPTION</code>.</p></li>
<li><p>Set up a <code>.gitignore</code> file to make sure you don’t accidentally check in
any compiled files (learn more about this in <a href="git.html#git">git</a>).</p></li>
<li>
<p>Tell you the two roxygen tags you need to add to your package:</p>
<div class="sourceCode" id="cb260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' @useDynLib your-package-name</span>
<span class="co">#' @importFrom Rcpp sourceCpp</span>
<span class="cn">NULL</span>
<span class="co">#&gt; NULL</span></code></pre></div>
</li>
</ul>
<div id="cpp-workflow" class="section level3">
<h3>
<span class="header-section-number">15.1.1</span> Workflow<a class="anchor" aria-label="anchor" href="#cpp-workflow"><i class="fas fa-link"></i></a>
</h3>
<p>Once you’re set up, the basic workflow should now be familiar:</p>
<ol style="list-style-type: decimal">
<li>
<p>Create a new C++ file:</p>
<div class="inline-figure">
<img src="images/new-cpp.png"><!-- -->
</div>
<p>The default template looks like this:</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb261-1"><a href="src.html#cb261-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb261-2"><a href="src.html#cb261-2"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp;</span>
<span id="cb261-3"><a href="src.html#cb261-3"></a></span>
<span id="cb261-4"><a href="src.html#cb261-4"></a><span class="co">// Below is a simple example of exporting a C++ function to R. You can</span></span>
<span id="cb261-5"><a href="src.html#cb261-5"></a><span class="co">// source this function into an R session using the Rcpp::sourceCpp </span></span>
<span id="cb261-6"><a href="src.html#cb261-6"></a><span class="co">// function (or via the Source button on the editor toolbar)</span></span>
<span id="cb261-7"><a href="src.html#cb261-7"></a></span>
<span id="cb261-8"><a href="src.html#cb261-8"></a><span class="co">// For more on using Rcpp click the Help button on the editor toolbar</span></span>
<span id="cb261-9"><a href="src.html#cb261-9"></a></span>
<span id="cb261-10"><a href="src.html#cb261-10"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb261-11"><a href="src.html#cb261-11"></a><span class="dt">int</span> timesTwo(<span class="dt">int</span> x) {</span>
<span id="cb261-12"><a href="src.html#cb261-12"></a>   <span class="cf">return</span> x * <span class="dv">2</span>;</span>
<span id="cb261-13"><a href="src.html#cb261-13"></a>}</span></code></pre></div>
<p>It includes a basic function and some instructions to get started. The
two most important parts are the header <code>#include</code>, and the special
attribute <code>// [[Rcpp::export]]</code>.</p>
</li>
<li><p>Generate the necessary modifications to your <code>NAMESPACE</code> by documenting
them with Ctrl/Cmd + Shift + D.</p></li>
<li><p>Click Build &amp; Reload in the build pane, or press Ctrl/Cmd + Shift + B. You can
continue to use the standard <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code> process but it is more
risky. Because you’re loading and unloading C code, the chances of
corrupting memory are high, and you’re better off with the safer, but
slower, “Build &amp; Reload” which installs the package then restarts R.</p></li>
<li><p>Run <code>timesTwo(10)</code> from the console to check that it works.</p></li>
</ol>
<p>Behind the scenes, “Build and reload” is doing a lot of work for you. They:</p>
<ul>
<li><p>Set up your R environment to compile code and warn you if you’re missing
necessary pieces.</p></li>
<li><p>Call <code><a href="https://rdrr.io/pkg/Rcpp/man/compileAttributes.html">Rcpp::compileAttributes()</a></code>. This inspects your <code>.cpp</code> functions
looking for <strong>attributes</strong> of the form <code>// [[Rcpp::export]]</code>. When it finds
one, it generates the code needed to make the function available in
R, and creates <code>src/RcppExports.cpp</code> and <code>R/RcppExports.R</code>. You should never
modify these files by hand.</p></li>
<li><p>Build a DLL (dynamically linked library) and make it available to R.</p></li>
</ul>
</div>
<div id="cpp-man" class="section level3">
<h3>
<span class="header-section-number">15.1.2</span> Documentation<a class="anchor" aria-label="anchor" href="#cpp-man"><i class="fas fa-link"></i></a>
</h3>
<p>Each exported C++ function automatically gets a wrapper function (it will be located in <code>R/RcppExports.R</code>). For example, the R <code>timesTwo()</code> function looks like:</p>
<div class="sourceCode" id="cb262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">timesTwo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html">.Call</a></span><span class="op">(</span><span class="st">'timesTwo'</span>, PACKAGE <span class="op">=</span> <span class="st">'mypackage'</span>, <span class="va">x</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This uses the base function <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code> to execute the C function <code>timesTwo</code> provided by “mypackage”. You can use roxygen2 to document this like a regular R function. But instead of using <code>#'</code> for comments use <code>//'</code>, the C++ convention:</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb263-1"><a href="src.html#cb263-1"></a><span class="co">//' Multiply a number by two</span></span>
<span id="cb263-2"><a href="src.html#cb263-2"></a><span class="co">//' </span></span>
<span id="cb263-3"><a href="src.html#cb263-3"></a><span class="co">//' @param x A single integer.</span></span>
<span id="cb263-4"><a href="src.html#cb263-4"></a><span class="co">//' @export</span></span>
<span id="cb263-5"><a href="src.html#cb263-5"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb263-6"><a href="src.html#cb263-6"></a><span class="dt">int</span> timesTwo(<span class="dt">int</span> x) {</span>
<span id="cb263-7"><a href="src.html#cb263-7"></a>   <span class="cf">return</span> x * <span class="dv">2</span>;</span>
<span id="cb263-8"><a href="src.html#cb263-8"></a>}</span></code></pre></div>
<p>That generates roxygen comments in <code>R/RcppExports.R</code>:</p>
<div class="sourceCode" id="cb264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' Multiply a number by two</span>
<span class="co">#' </span>
<span class="co">#' @param x A single integer.</span>
<span class="co">#' @export</span>
<span class="va">timesTwo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html">.Call</a></span><span class="op">(</span><span class="st">'timesTwo'</span>, PACKAGE <span class="op">=</span> <span class="st">'mypackage'</span>, <span class="va">x</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The distinctions between the two export directives is important:</p>
<ul>
<li><p><code>[[Rcpp::export]]</code> makes the C++ function available to R. If you have
trouble remembering the exact details, note that everything comes in
twos: Two <code>/</code>, two <code>[</code>, two <code>:</code> and two <code>]</code>.</p></li>
<li><p><code>@export</code> makes the R wrapper function available outside your package by
adding it to the <code>NAMESPACE</code>.</p></li>
</ul>
</div>
<div id="cpp-export" class="section level3">
<h3>
<span class="header-section-number">15.1.3</span> Exporting C++ code<a class="anchor" aria-label="anchor" href="#cpp-export"><i class="fas fa-link"></i></a>
</h3>
<p>To make your C++ code callable from C++ code in other packages, add:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb265-1"><a href="src.html#cb265-1"></a><span class="co">// [[Rcpp::interfaces(r, cpp)]]</span></span></code></pre></div>
<p>This will generate a header file, <code>inst/include/mypackage.h</code> that can be included by other packages (The low-level details are described in <a href="src.html#c-export">Exporting C code</a>). See “<a href="http://dirk.eddelbuettel.com/code/rcpp/Rcpp-attributes.pdf">Rcpp Attributes</a>” for more details, including how to combine hand-written and automatically generated header files.</p>
</div>
<div id="cpp-import" class="section level3">
<h3>
<span class="header-section-number">15.1.4</span> Importing C++ code<a class="anchor" aria-label="anchor" href="#cpp-import"><i class="fas fa-link"></i></a>
</h3>
<p>To use C++ code from another package:</p>
<ol style="list-style-type: decimal">
<li><p>In <code>DESCRIPTION</code>, add <code>LinkingTo: otherPackage</code>. Confusingly this has nothing
to do with the linker. It’s called <code>LinkingTo</code> because it adds
<code>otherPackage/include</code> to the include path, allowing you to dynamically
“link to” other code via the headers.</p></li>
<li>
<p>In the C++ file, add:</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb266-1"><a href="src.html#cb266-1"></a><span class="pp">#include </span><span class="im">&lt;otherPackage.h&gt;</span></span></code></pre></div>
</li>
<li><p>C++ functions from otherPackage will be included in the <code>otherPackage</code>
namespace. Use <code>otherPackage::foo()</code> to access functions, or make
them available globally with <code>using namespace otherPackage</code>.</p></li>
</ol>
</div>
<div id="cpp-best-practices" class="section level3">
<h3>
<span class="header-section-number">15.1.5</span> Best practices<a class="anchor" aria-label="anchor" href="#cpp-best-practices"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>To print output use <code>Rcout &lt;&lt; ...</code> (not <code>cout &lt;&lt; ...</code>). This prints to
the right place, which might be a GUI console or a file (if <code><a href="https://rdrr.io/r/base/sink.html">sink()</a></code>
is active)</p></li>
<li><p>In long-running loops, regularly run <code>Rcpp::checkUserInterrupt()</code>. This
aborts your C++ if the user has pressed Ctrl + C or Escape in R.</p></li>
<li><p>Use <code>.h</code> extension for headers and include files. (If you don’t
<code>R CMD check</code> will complain).</p></li>
<li><p>Follow Martyn Plummer’s recommendations on
<a href="https://journal.r-project.org/archive/2011-2/RJournal_2011-2_Plummer.pdf">Portable C++ for R packages</a>.</p></li>
<li>
<p>Whenever you use C++ code in your package, you need to clean up after
yourself when your package is unloaded. Do this by writing a <code><a href="https://rdrr.io/r/base/ns-hooks.html">.onUnload()</a></code>
function that unloads the DLL:</p>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.onUnload</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">libpath</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/library.dynam.html">library.dynam.unload</a></span><span class="op">(</span><span class="st">"mypackage"</span>, <span class="va">libpath</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</li>
<li>
<p>Use <code>clang</code> instead of <code>gcc</code> to compile your C++ code: it gives much
better error messages. You can make <code>clang</code> the default by creating a
<code>.R/Makevars</code> (linux and mac) or <code>.R/Makevars.win</code> (windows) file in
your home directory that contains:</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb268-1"><a href="src.html#cb268-1"></a><span class="va">CXX=</span>clang++</span></code></pre></div>
<p>(If you don’t know where your home directory is <code>path.expand("~")</code> will
tell you.)</p>
</li>
<li>
<p>To speed up compilation on linux or mac, install <code>ccache</code>, then replace
<code>~/.R/Makevars</code> with:</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb269-1"><a href="src.html#cb269-1"></a><span class="va">CC=</span>ccache <span class="fu">clang</span> -Qunused-arguments</span>
<span id="cb269-2"><a href="src.html#cb269-2"></a><span class="va">CXX=</span>ccache <span class="fu">clang</span>++ -Qunused-arguments</span>
<span id="cb269-3"><a href="src.html#cb269-3"></a><span class="va">CCACHE_CPP2=</span>yes</span></code></pre></div>
</li>
</ul>
</div>
</div>
<div id="clang" class="section level2">
<h2>
<span class="header-section-number">15.2</span> C<a class="anchor" aria-label="anchor" href="#clang"><i class="fas fa-link"></i></a>
</h2>
<p>If you’re writing new compiled code, it’s almost always better to use Rcpp. It’s less work, more consistent, better documented, and it has better tools. However, there are some reasons to choose C:</p>
<ul>
<li>You’re working with an older package that already uses the C API.</li>
<li>You’re binding to an existing C library.</li>
</ul>
<p>There are two ways to call C functions from R: <code><a href="https://rdrr.io/r/base/Foreign.html">.C()</a></code> and <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code>. <code><a href="https://rdrr.io/r/base/Foreign.html">.C()</a></code> is a quick and dirty way to call an C function that doesn’t know anything about R because <code><a href="https://rdrr.io/r/base/Foreign.html">.C()</a></code> automatically converts between R vectors and the corresponding C types. <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code> is more flexible, but more work: your C function needs to use the R API to convert its inputs to standard C data types.</p>
<div id="getting-started-with-.call" class="section level3">
<h3>
<span class="header-section-number">15.2.1</span> Getting started with <code>.Call()</code><a class="anchor" aria-label="anchor" href="#getting-started-with-.call"><i class="fas fa-link"></i></a>
</h3>
<p>To call a C function from R, you first need a C function! In an R package, C code lives in <code>.c</code> files in <code>src/</code>. You’ll need to include two header files:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb270-1"><a href="src.html#cb270-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb270-2"><a href="src.html#cb270-2"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span></code></pre></div>
<p>(Yes, including <code>&lt;Rinternals.h&gt;</code> seems like bad form. On top of that, doing so doesn’t actually give you access to the “internal” internal API unless you set some additional flags. The default just gives you access to the “public” internal API, which is both necessary and done for safety’s sake. Yes, this is confusing.)</p>
<p>These headers allow you to access R’s C API. Unfortunately this API is not well documented. I’d recommend starting with my notes at <a href="http://adv-r.had.co.nz/C-interface.html">R’s C interface</a>. After that, read “<a href="https://cran.rstudio.com/doc/manuals/r-devel/R-exts.html#The-R-API">The R API</a>” in “Writing R Extensions”. A number of exported functions are not documented, so you’ll also need to read the <a href="https://github.com/wch/r-source">R source code</a> to figure out the details.</p>
<p>Here’s the bare minimum you need to know: C functions that talk to R must use the <code>SEXP</code> type for both inputs and outputs. <code>SEXP</code>, short for S expression, is the C struct used to represent every type of object in R. A C function typically starts by converting <code>SEXP</code>s to atomic C objects, and ends by converting C objects back to a <code>SEXP</code>. (The R API is designed so that these conversions often don’t require copying.) The following table lists the functions that convert length one R vectors to and from C scalars:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>R type</th>
<th>C type</th>
<th>R -&gt; C</th>
<th>C -&gt; R</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>integer</td>
<td>int</td>
<td><code>asInteger(x)</code></td>
<td><code>ScalarInteger(x)</code></td>
</tr>
<tr class="even">
<td>numeric</td>
<td>double</td>
<td><code>asReal(x)</code></td>
<td><code>ScalarReal(x)</code></td>
</tr>
<tr class="odd">
<td>logical</td>
<td>int</td>
<td><code>asLogical(x)</code></td>
<td><code>ScalarLogical(x)</code></td>
</tr>
<tr class="even">
<td>character</td>
<td>const char*</td>
<td><code>CHAR(asChar(x))</code></td>
<td><code>mkString(x)</code></td>
</tr>
</tbody>
</table></div>
<p>We now have enough information to write a simple C function that can add two numbers:</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb271-1"><a href="src.html#cb271-1"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb271-2"><a href="src.html#cb271-2"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb271-3"><a href="src.html#cb271-3"></a></span>
<span id="cb271-4"><a href="src.html#cb271-4"></a>SEXP add_(SEXP x_, SEXP y_) {</span>
<span id="cb271-5"><a href="src.html#cb271-5"></a>  <span class="dt">double</span> x = asReal(x_);</span>
<span id="cb271-6"><a href="src.html#cb271-6"></a>  <span class="dt">double</span> y = asReal(y_);</span>
<span id="cb271-7"><a href="src.html#cb271-7"></a>  </span>
<span id="cb271-8"><a href="src.html#cb271-8"></a>  <span class="dt">double</span> sum = x + y;</span>
<span id="cb271-9"><a href="src.html#cb271-9"></a>  </span>
<span id="cb271-10"><a href="src.html#cb271-10"></a>  <span class="cf">return</span> ScalarReal(sum);</span>
<span id="cb271-11"><a href="src.html#cb271-11"></a>}</span></code></pre></div>
<p>We call this from R with <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code>:</p>
<div class="sourceCode" id="cb272"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' @useDynLib mypackage add_</span>
<span class="va">add</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/CallExternal.html">.Call</a></span><span class="op">(</span><span class="va">add_</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span></code></pre></div>
<p>Where does the first argument to <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code>, <code>add_</code>, come from? It comes from <code>@useDynLib</code>, which creates a line in the NAMESPACE that looks like:</p>
<pre><code>useDynLib(mypackage, add_)</code></pre>
<p>This directive instructs R to create an object called <code>add_</code> which describes a C function pointer:</p>
<div class="sourceCode" id="cb274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mypackage</span><span class="fu">:::</span><span class="va">add_</span>
<span class="co">#&gt; $name</span>
<span class="co">#&gt; [1] "add_"</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $address</span>
<span class="co">#&gt; &lt;pointer: 0x107be3f40&gt;</span>
<span class="co">#&gt; $package</span>
<span class="co">#&gt; NULL</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attr(,"class")</span>
<span class="co">#&gt; [1] "NativeSymbolInfo"</span></code></pre></div>
<p><code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code> takes the pointer to a C function and calls it. All R objects have the same C type (the <code>SEXP</code>) you need to make sure the arguments are of the type you expect. Either do that in the R function, in the C function, or just accept that R will crash every time you accidentally supply the wrong type of input.</p>
<p>The most complicated part of working with the <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code> interface is memory-management. Whenever you create an R-level data structure, you must <code>PROTECT()</code> it so the garbage collector doesn’t try and free it, then <code>UNPROTECT()</code> it at the end of the function. This topic is beyond the scope of this chapter, but you can learn more about it at <a href="http://adv-r.had.co.nz/C-interface.html#c-vectors" class="uri">http://adv-r.had.co.nz/C-interface.html#c-vectors</a>.</p>
</div>
<div id="getting-started-with-.c" class="section level3">
<h3>
<span class="header-section-number">15.2.2</span> Getting started with <code>.C()</code><a class="anchor" aria-label="anchor" href="#getting-started-with-.c"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/Foreign.html">.C()</a></code> is simpler than <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code> and can be useful if you already have standard C code. Since you never create R objects in <code><a href="https://rdrr.io/r/base/Foreign.html">.C()</a></code>, you never need to worry about memory management. To use it, you first write a void C function, using in-place modification of function parameters to return values:</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb275-1"><a href="src.html#cb275-1"></a><span class="dt">void</span> add_(<span class="dt">double</span>* x, <span class="dt">double</span>* y, <span class="dt">double</span>* out) {</span>
<span id="cb275-2"><a href="src.html#cb275-2"></a>  out[<span class="dv">0</span>] = x[<span class="dv">0</span>] + y[<span class="dv">0</span>];</span>
<span id="cb275-3"><a href="src.html#cb275-3"></a>}</span></code></pre></div>
<p>Then like <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code> you create an R wrapper:</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' @useDynLib mypackage add_</span>
<span class="va">add</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Foreign.html">.C</a></span><span class="op">(</span><span class="va">add_</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>
<span class="op">}</span></code></pre></div>
<p>(Here we extract the 3rd element of the result because that corresponds to the out parameter.)</p>
<p><code><a href="https://rdrr.io/r/base/Foreign.html">.C()</a></code> automatically converts back and forth between R vectors and their C equivalents:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>R type</th>
<th>C type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>logical</td>
<td><code>int*</code></td>
</tr>
<tr class="even">
<td>integer</td>
<td><code>int*</code></td>
</tr>
<tr class="odd">
<td>double</td>
<td><code>double*</code></td>
</tr>
<tr class="even">
<td>character</td>
<td><code>char**</code></td>
</tr>
<tr class="odd">
<td>raw</td>
<td><code>unsigned char*</code></td>
</tr>
</tbody>
</table></div>
<p>Note that <code><a href="https://rdrr.io/r/base/Foreign.html">.C()</a></code> assumes your function doesn’t know how to deal with missing values and will throw an error if any arguments contain an NA. If it can correctly handle missing values, set <code>NAOK = TRUE</code> in the call to <code><a href="https://rdrr.io/r/base/Foreign.html">.C()</a></code>.</p>
<p>You can learn more about <code><a href="https://rdrr.io/r/base/Foreign.html">.C()</a></code> in its help, <code><a href="https://rdrr.io/r/base/Foreign.html">?.C</a></code> and in <a href="https://cran.rstudio.com/doc/manuals/r-devel/R-exts.html#Interface-functions-_002eC-and-_002eFortran">R-extensions</a>.</p>
</div>
<div id="c-workflow" class="section level3">
<h3>
<span class="header-section-number">15.2.3</span> Workflow<a class="anchor" aria-label="anchor" href="#c-workflow"><i class="fas fa-link"></i></a>
</h3>
<p>The usual workflow still applies:</p>
<ol style="list-style-type: decimal">
<li>Modify the C code.</li>
<li>Build and reload the package with Ctrl/Cmd + Shift + B</li>
<li>Experiment at the console.</li>
</ol>
<p>The first time you add <code>@useDynLib</code>, you’ll also need to run <code><a href="https://devtools.r-lib.org/reference/document.html">devtools::document()</a></code> (Ctrl/Cmd + Shift + D) and reload the package.</p>
</div>
<div id="c-export" class="section level3">
<h3>
<span class="header-section-number">15.2.4</span> Exporting C code<a class="anchor" aria-label="anchor" href="#c-export"><i class="fas fa-link"></i></a>
</h3>
<p>R packages need to provide DLLs that can be relocated; DLLs that work regardless of where they live on disk. This is because most R users don’t build packages from source. Instead, they get binaries from CRAN that can get installed in many different places. This need for relocatable DLLs adds a few more steps to the job of importing and exporting C code for R packages (the same problem arises for C++, but Rcpp attributes automate the manual steps described below).</p>
<p>R solves this problem using <strong>function registration</strong>. To export a <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code> C function, you register it with <code>R_RegisterCCallable()</code>. To import a <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code> C function, you get a pointer to it with <code>R_GetCCallable()</code>. Similar techniques are available for <code><a href="https://rdrr.io/r/base/Foreign.html">.C()</a></code> C functions, but are beyond the scope of this book. As we’ll see below, a user-friendly package will do both these tasks, so users of the package can ignore the details and simply include a header a file.</p>
<p>[Sidebar: Confusingly, there’s another type of function registration. Instead of registering C functions using the namespace (i.e. <code>@useDynLib pkg fun</code>), you can register them with <code>R_registerRoutines()</code> and <code>@useDynLib mypackage, .registration = TRUE</code>. To learn the details read <a href="https://cran.r-project.org/doc/manuals/R-exts.html#Registering-native-routines">Registering native extensions</a> in “Writing R extensions”.]</p>
<p>To register a function, call <code>R_RegisterCCallable()</code>, defined in <code>&lt;R_ext/Rdynload.h&gt;</code>. Function registration should be done in a function called <code>R_init_&lt;mypackage&gt;</code>. This function is called automatically when the “mypackage” DLL is loaded. <code>R_RegisterCCallable()</code> has three arguments:</p>
<ul>
<li>A pointer to the DLL.</li>
<li>The name of the function.</li>
<li>A pointer to the function, cast as <code>DL_FUNC</code> (i.e. a <strong>d</strong>ynamically
<strong>l</strong>oaded <strong>func</strong>tion).</li>
</ul>
<p>The following code registers the <code>add_()</code> function defined above:</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb277-1"><a href="src.html#cb277-1"></a><span class="pp">#include </span><span class="im">"add.h"</span></span>
<span id="cb277-2"><a href="src.html#cb277-2"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Rdynload.h&gt;</span></span>
<span id="cb277-3"><a href="src.html#cb277-3"></a></span>
<span id="cb277-4"><a href="src.html#cb277-4"></a><span class="dt">void</span> R_init_mypackage(DllInfo *info) {</span>
<span id="cb277-5"><a href="src.html#cb277-5"></a>  R_RegisterCCallable(<span class="st">"mypackage"</span>, <span class="st">"add"</span>,  (DL_FUNC) &amp;add_);</span>
<span id="cb277-6"><a href="src.html#cb277-6"></a>}</span></code></pre></div>
<p>It doesn’t matter where this code lives, but it’s usually put in a file called <code>src/mypackage-init.c</code>.</p>
<p>To access a registered function from another package, call <code>R_GetCCallable()</code>. It has two arguments, the package name and the function name. It returns a function pointer. The function pointer has no type information, so it should always be wrapped in a helper function that defines the inputs:</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb278-1"><a href="src.html#cb278-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Rdynload.h&gt;</span></span>
<span id="cb278-2"><a href="src.html#cb278-2"></a><span class="pp">#include </span><span class="im">&lt;R.h&gt;</span></span>
<span id="cb278-3"><a href="src.html#cb278-3"></a><span class="pp">#include </span><span class="im">&lt;Rinternals.h&gt;</span></span>
<span id="cb278-4"><a href="src.html#cb278-4"></a></span>
<span id="cb278-5"><a href="src.html#cb278-5"></a>SEXP add_(SEXP x, SEXP y) {</span>
<span id="cb278-6"><a href="src.html#cb278-6"></a>  <span class="dt">static</span> SEXP(*fun)(SEXP, SEXP) = NULL;</span>
<span id="cb278-7"><a href="src.html#cb278-7"></a>  <span class="cf">if</span> (fun == NULL)</span>
<span id="cb278-8"><a href="src.html#cb278-8"></a>    fun = (SEXP(*)(SEXP, SEXP)) R_GetCCallable(<span class="st">"mypackage"</span>, <span class="st">"add"</span>);</span>
<span id="cb278-9"><a href="src.html#cb278-9"></a>  <span class="cf">return</span> fun(x, y);</span>
<span id="cb278-10"><a href="src.html#cb278-10"></a>}</span></code></pre></div>
<p>Rather than relying on each package that imports your C code to do this correctly, you should instead do it for them. Write <code>inst/include/mypackageAPI.h</code> which provides a wrapper function for each exported function. A popular package that does that is <a href="https://cran.r-project.org/web/packages/xts/">xts</a>. Download the source package and look in the <code>include/</code> directory to see what it does.</p>
</div>
<div id="c-import" class="section level3">
<h3>
<span class="header-section-number">15.2.5</span> Importing C code<a class="anchor" aria-label="anchor" href="#c-import"><i class="fas fa-link"></i></a>
</h3>
<p>Using C code from another package varies based on how the package is implemented:</p>
<ul>
<li><p>If it uses the system described above, all you need is <code>LinkingTo: otherPackage</code>
in the <code>DESCRIPTION</code>, and <code>#include otherPackageAPI.h</code> in the C file. (Remember
<code>LinkingTo</code> is not about the linker, but actually affects the include path).</p></li>
<li><p>If it registers the functions, but doesn’t provide a header file, you’ll
need to write the wrapper yourself. Since you’re not using any header
files from the package, use <code>Imports</code> and not <code>LinkingTo</code>. You also need to
make sure the package is loaded. You can do this by importing any function
with <code>@importFrom mypackage foo</code>, or by adding <code><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace("mypackage",  quietly = TRUE)</a></code> to <code><a href="https://rdrr.io/r/base/ns-hooks.html">.onLoad()</a></code>.</p></li>
<li><p>If it doesn’t register the functions, you can’t use them. You’ll have to
ask the maintainer nicely or even provide a pull request.</p></li>
</ul>
</div>
<div id="c-best-practices" class="section level3">
<h3>
<span class="header-section-number">15.2.6</span> Best practices<a class="anchor" aria-label="anchor" href="#c-best-practices"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li><p>Avoid calls to <code>assert()</code>, <code>abort()</code> and <code>exit()</code>: these will kill the
R process, not just your C code. Instead, use <code>error()</code> which is
equivalent to calling <code><a href="https://rdrr.io/r/base/stop.html">stop()</a></code> in R.</p></li>
<li><p>To print output use <code>Rprintf()</code>, not <code>printf()</code>. Doing so always prints to
the right place, whether it’s the GUI console or a file (if <code><a href="https://rdrr.io/r/base/sink.html">sink()</a></code> is
active).</p></li>
<li><p>In long-running loops, regularly call <code>R_CheckUserInterrupt()</code> to allow
the user to interrupt the C code.</p></li>
<li><p>Don’t use C’s random number generators (like <code>rand()</code> or <code>random()</code>),
instead use the C API to R’s rngs: <code>unif_rand()</code>, <code>norm_rand()</code>, etc.
Note the caveats in <a href="https://cran.rstudio.com/doc/manuals/r-devel/R-exts.html#Random-numbers">“Random number generation”</a> - you must call <code>GetRNGstate()</code> before and
<code>PutRNGstate()</code> after.</p></li>
<li><p>Use R macros <code>ISNAN(x)</code> and <code>R_FINITE(x)</code> to check for NaNs and infinite
values. These work on more platforms than the C99 <code>isnan()</code> and <code>isfinite()</code>.</p></li>
<li>
<p>Like with C++, whenever you use C code in your package, you should unload the
DLL when the package is unloaded:</p>
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.onUnload</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">libpath</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/library.dynam.html">library.dynam.unload</a></span><span class="op">(</span><span class="st">"mypackage"</span>, <span class="va">libpath</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</li>
<li>
<p>Use <code>clang</code> instead of <code>gcc</code> to compile your C code: it gives much
better error messages. You can make <code>clang</code> the default by creating a
<code>~/.R/Makevars</code> that contains:</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb280-1"><a href="src.html#cb280-1"></a><span class="va">CC=</span>clang</span></code></pre></div>
</li>
</ul>
</div>
</div>
<div id="src-debugging" class="section level2">
<h2>
<span class="header-section-number">15.3</span> Debugging compiled code<a class="anchor" aria-label="anchor" href="#src-debugging"><i class="fas fa-link"></i></a>
</h2>
<p>It’s possible, with a little extra work, to use an interactive debugger to debug your C/C++ in the same way that you can use <code><a href="https://rdrr.io/r/base/browser.html">browser()</a></code> and <code><a href="https://rdrr.io/r/base/debug.html">debug()</a></code> to debug your R code. Unfortunately you won’t be able to use RStudio, you’ll have to run R from the command line.</p>
<p>Open a shell (e.g. with Tools | Shell…) and start R by typing:</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb281-1"><a href="src.html#cb281-1"></a><span class="co"># If you compile with clang</span></span>
<span id="cb281-2"><a href="src.html#cb281-2"></a><span class="ex">R</span> --debugger=lldb</span>
<span id="cb281-3"><a href="src.html#cb281-3"></a><span class="co"># If you compile with gcc</span></span>
<span id="cb281-4"><a href="src.html#cb281-4"></a><span class="ex">R</span> --debugger=gdb</span></code></pre></div>
<p>This will start either <a href="https://lldb.llvm.org">lldb</a> or <a href="https://www.gnu.org/software/gdb/">gdb</a>, the debuggers that work with code produced by <code>clang</code> or <code>gcc</code> respectively. Like R, <code>lldb</code> and <code>gdb</code> provide a REPL, a run-eval-print loop where you enter commands and then look at the results. In the examples below I’ll show the results of <code>lldb</code>, which is what I use (the output from <code>gdb</code> is similar). For each interactive command I’ll tell you the explicit, but long, <code>lldb</code> command and the short, but cryptic, <code>gdb</code> command. Because <code>lldb</code> understand all <code>gdb</code> commands, you can use commands from either in <code>lldb</code>, depending on whether you choose to be explicit or terse.</p>
<p>Once you’ve started the debugger, start R by typing <code>process start</code> (lldb) or <code>run</code> (gdb). Now when your C/C++ code crashes you’ll be dumped into an interactive debugger instead of getting a cryptic error message and a crash.</p>
<p>Let’s start with a simple C++ function that writes to memory it doesn’t “own”:</p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Rcpp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/cppFunction.html">cppFunction</a></span><span class="op">(</span><span class="st">"
bool mistake() {
  NumericVector x(1);
  int n = INT_MAX;
  x[n] = 0;
  return true;
}
"</span>, plugins <span class="op">=</span> <span class="st">"debug"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span>, rebuild <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">mistake</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Use <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code> to load the current package. Then copy and paste the code that creates the bug. Here’s a crash report from a package I was working on:</p>
<pre><code>Process 32743 stopped
* thread #1: tid = 0x1f79f6, 0x... gggeom.so...`
   frame #0: 0x0.. gggeom.so`vw_distance(x=..., y=...) + ... at vw-distance.cpp:54
   51        int prev_idx = prev[idx];
   52   
   53       next[prev[idx]] = next_idx;
-&gt; 54       prev[next[idx]] = prev_idx;
   55       prev[idx] = -1;
   56       next[idx] = -1;
   57</code></pre>
<p>It tells us that the crash occurred because of a <code>EXC_BAD_ACCESS</code> - this is one of the most common types of crash in C/C++ code. Helpfully, lldb shows exactly which line of C++ code caused the problem: <code>vw-distance.cpp:54</code>. Often just knowing where the problem occurs is enough to fix it. But we’re also now at an interactive prompt. There are many commands you can run here to explore what’s going on. The most useful are listed below:</p>
<ul>
<li><p>See a list of all commands: <code>help</code>.</p></li>
<li><p>Show your location on the callstack with <code>thread backtrace</code>/<code>bt</code>. This
will print a list of calls leading up to the error, much like <code><a href="https://rdrr.io/r/base/traceback.html">traceback()</a></code>
does in R. Navigate the callstack with <code>frame select &lt;n&gt;</code>/<code>frame &lt;n&gt;</code>, or
<code>up</code> and <code>down</code>.</p></li>
<li><p>Evaluate the next expression with <code>thread step-over</code>/<code><a href="https://rdrr.io/r/base/Control.html">next</a></code>, or step into it
with <code>thread step-in</code>/<code>step</code>. Continue executing the rest of the code with
<code>thread step-out</code>/<code>finish</code></p></li>
<li><p>Show all variables defined in the current frame with <code>frame variable</code>/
<code>info locals</code>, or print the value of a single variable with
<code>frame variable &lt;var&gt;</code>/<code>p &lt;var&gt;</code>.</p></li>
</ul>
<p>Instead of waiting for a crash to occur you can also set breakpoints in your code. To do so, start the debugger, run R, then:</p>
<ol style="list-style-type: decimal">
<li><p>Press <code>Ctrl + C</code></p></li>
<li><p>Type <code>breakpoint set --file foo.c --line 12</code>/<code>break foo.c:12</code>.</p></li>
<li><p><code>process continue</code>/<code>c</code> to go back to the R console. Now run the C code
you’re interested in, and the debugger will stop when it gets to the
specified line.</p></li>
</ol>
<p>You can also set a breakpoint for any C++ exception: this allows you to figure out exactly where a C++ error occurs:</p>
<ol style="list-style-type: decimal">
<li><p>Press <code>Ctrl + C</code></p></li>
<li><p>Type <code>breakpoint set -E c++</code>.</p></li>
<li><p><code>process continue</code>/<code>c</code> to go back to the R console. Now if an exception
is thrown in C++ code (or by R’s C API when wrapped in Rcpp code), the
debugger will stop.</p></li>
</ol>
<p>Finally, you can also use the debugger if your code is stuck in an infinite loop. Press <code>Ctrl + C</code> to break into the debugger and you’ll see which line of code is causing the problem.</p>
</div>
<div id="make" class="section level2">
<h2>
<span class="header-section-number">15.4</span> Makefiles<a class="anchor" aria-label="anchor" href="#make"><i class="fas fa-link"></i></a>
</h2>
<p>While makefiles are beyond the scope of this book, they are a useful tool. A good, gentle introduction with a focus on reproducible research is Karl Broman’s <a href="http://kbroman.org/minimal_make/">“Minimal make”</a>.</p>
<p>Generally, R packages should avoid a custom <code>Makefile</code>. Instead, use <code>Makevars</code>. <code>Makevars</code> is a make file that overrides the default make file generated by R (which is located at <code>file.path(R.home("etc"), "Makeconf")</code>). This allows you to take advantage of R’s default behaviour (it’s over 150 lines, and battle-tested across many years and many systems, so you want to!) while being able to set the flags you need. The most commonly used flags are:</p>
<ul>
<li><p><code>PKG_LIBS</code>: Linker flags. A common use is <code>PKG_LIBS = $(BLAS_LIBS)</code>. This
allows you to use the same BLAS library as R.</p></li>
<li><p><code>PKG_CFLAGS</code> &amp; <code>PKG_CXXFLAGS</code>: C and C++ flags. Most commonly used to set
define directives with <code>-D</code>.</p></li>
<li><p><code>PKG_CPPFLAGS</code>: Pre-processor flags (not C++ flags!). Most commonly used to
set include directories with <code>-I</code>. Any package listed in the <code>LinkingTo</code> field
in the <code>DESCRIPTION</code> will be automatically included - you do not need to
explicitly add it.</p></li>
</ul>
<p>To set flags only on Windows, use <code>Makevars.win</code>. To build a <code>Makevars</code> with <code>configure</code>, use <code>Makevars.in</code>.</p>
<p>By default, R will use the system make, which is not always GNU compatible (i.e. on Solaris). If you want to use GNU extensions (which are extremely common), add <code>SystemRequirements: GNU make</code> to <code>DESCRIPTION</code>. If you’re not sure if you’re using GNU extensions, play it safe and add it to the system requirement.</p>
</div>
<div id="src-other" class="section level2">
<h2>
<span class="header-section-number">15.5</span> Other languages<a class="anchor" aria-label="anchor" href="#src-other"><i class="fas fa-link"></i></a>
</h2>
<p>It is possible to connect R to other languages, but the interfaces are not as nice as the one for C++:</p>
<ul>
<li><p><strong>Fortran</strong>: It’s possible to call Fortran subroutines directly with
<code><a href="https://rdrr.io/r/base/Foreign.html">.Fortran()</a></code>, or via C or C++ with <code><a href="https://rdrr.io/r/base/CallExternal.html">.Call()</a></code>. See <code><a href="https://rdrr.io/r/base/Foreign.html">?.Fortran</a></code> and</p></li>
<li><p><strong>Java</strong>: The <a href="http://www.rforge.net/rJava/">rJava</a> package makes it
possible to call Java code from within R. Note that unlike with C and C++,
passing an R object to a Java call will involve a copy operation, something
which has serious performance implications.</p></li>
</ul>
</div>
<div id="src-workflow" class="section level2">
<h2>
<span class="header-section-number">15.6</span> Development workflow<a class="anchor" aria-label="anchor" href="#src-workflow"><i class="fas fa-link"></i></a>
</h2>
<p>When developing C or C++ code, it’s usually better to use RStudio’s Build &amp; Reload instead of <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all()</a></code>. Note this is known as “Install and Restart” in more recent versions of RStudio. If you have C objects that persist between reloads, and you change the data structure, then it’s better to use Install and Restart: otherwise there’s a high chance of crashes due to differences between versions of your C code.</p>
</div>
<div id="src-cran" class="section level2">
<h2>
<span class="header-section-number">15.7</span> CRAN issues<a class="anchor" aria-label="anchor" href="#src-cran"><i class="fas fa-link"></i></a>
</h2>
<!--
Notes re: revision
Obviously cpp11 really changes things.
Does this chapter go away (or shrink and get absorbed into the R code chapter), and mostly link out to elsewhere?
-->
<p>Packages with compiled code are much more likely to have difficulties getting on CRAN than those without. The reason? Your package must build from source on all major platforms (Linux, Mac and Windows). This is hard!</p>
<ul>
<li><p>CRAN provides an automated service for checking R packages on windows:
<a href="https://win-builder.r-project.org">win-builder</a>. You can easily access this
by running <code><a href="https://devtools.r-lib.org/reference/check_win.html">devtools::check_win_release()</a></code>, which builds and uploads a package
bundle. The devel and oldrel R versions can be targeted with
<code><a href="https://devtools.r-lib.org/reference/check_win.html">check_win_devel()</a></code> and <code><a href="https://devtools.r-lib.org/reference/check_win.html">check_win_oldrelease()</a></code>, respectively.</p></li>
<li><p>I’ve tried to include the most important advice in this chapter, but I’d
recommend reading the entire section on <a href="https://cran.rstudio.com/doc/manuals/r-devel/R-exts.html#Portable-C-and-C_002b_002b-code">writing portable C and C++ code</a> in “Writing
R extensions”.</p></li>
<li><p>In exceptional circumstances, like binding to Windows-only functionality,
you may be able to opt-out of cross-platform requirement, but be prepared<br>
to make a strong case for it.</p></li>
</ul>
<p>The interface between CRAN’s automated and manual checking can be particularly frustrating for compiled code. Requirements vary from submission to submission, based on which maintainer you get and how much free time they have. The rules are inconsistently applied, but if your package doesn’t pass, it’s better to bite the bullet and make the change rather than trying to argue about it:</p>
<ul>
<li><p>Sometimes you will need to list all authors and copyright holders of included
code in the DESCRIPTION.</p></li>
<li>
<p>Sometimes your package will need to work on Solaris. But due to the difficulty
of accessing a computer running Solaris, fixing Solaris issues can be hard.
However, you will be in a stronger negotiating position if the package has no
problems on other platforms.</p>
<p>One common gotcha: gcc/clang flags <code>-Wall</code>, <code>-pedantic</code> and <code>-O0</code> do not work
with the default compiler on Solaris.</p>
</li>
</ul>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="data.html"><span class="header-section-number">14</span> External data</a></div>
<div class="next"><a href="inst.html"><span class="header-section-number">16</span> Installed files</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#src"><span class="header-section-number">15</span> Compiled code</a></li>
<li>
<a class="nav-link" href="#cpp"><span class="header-section-number">15.1</span> C++</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#cpp-workflow"><span class="header-section-number">15.1.1</span> Workflow</a></li>
<li><a class="nav-link" href="#cpp-man"><span class="header-section-number">15.1.2</span> Documentation</a></li>
<li><a class="nav-link" href="#cpp-export"><span class="header-section-number">15.1.3</span> Exporting C++ code</a></li>
<li><a class="nav-link" href="#cpp-import"><span class="header-section-number">15.1.4</span> Importing C++ code</a></li>
<li><a class="nav-link" href="#cpp-best-practices"><span class="header-section-number">15.1.5</span> Best practices</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#clang"><span class="header-section-number">15.2</span> C</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#getting-started-with-.call"><span class="header-section-number">15.2.1</span> Getting started with .Call()</a></li>
<li><a class="nav-link" href="#getting-started-with-.c"><span class="header-section-number">15.2.2</span> Getting started with .C()</a></li>
<li><a class="nav-link" href="#c-workflow"><span class="header-section-number">15.2.3</span> Workflow</a></li>
<li><a class="nav-link" href="#c-export"><span class="header-section-number">15.2.4</span> Exporting C code</a></li>
<li><a class="nav-link" href="#c-import"><span class="header-section-number">15.2.5</span> Importing C code</a></li>
<li><a class="nav-link" href="#c-best-practices"><span class="header-section-number">15.2.6</span> Best practices</a></li>
</ul>
</li>
<li><a class="nav-link" href="#src-debugging"><span class="header-section-number">15.3</span> Debugging compiled code</a></li>
<li><a class="nav-link" href="#make"><span class="header-section-number">15.4</span> Makefiles</a></li>
<li><a class="nav-link" href="#src-other"><span class="header-section-number">15.5</span> Other languages</a></li>
<li><a class="nav-link" href="#src-workflow"><span class="header-section-number">15.6</span> Development workflow</a></li>
<li><a class="nav-link" href="#src-cran"><span class="header-section-number">15.7</span> CRAN issues</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/r-pkgs/blob/main/src.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/r-pkgs/edit/main/src.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R Packages</strong>" was written by Hadley Wickham, Jennifer Bryan. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
