<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 6 The package within | R Packages</title>
<meta name="author" content="Hadley Wickham">
<meta name="author" content="Jennifer Bryan">
<meta name="description" content="This part of the book ends the same way it started, with the development of a small toy package. The whole game chapter established the basic mechanics, workflow, and tooling of package...">
<meta name="generator" content="bookdown 0.26 with bs4_book()">
<meta property="og:title" content="Chapter 6 The package within | R Packages">
<meta property="og:type" content="book">
<meta property="og:url" content="https://r-pkgs.org/package-within.html">
<meta property="og:image" content="https://r-pkgs.org/images/cover.png">
<meta property="og:description" content="This part of the book ends the same way it started, with the development of a small toy package. The whole game chapter established the basic mechanics, workflow, and tooling of package...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 6 The package within | R Packages">
<meta name="twitter:site" content="@hadley">
<meta name="twitter:description" content="This part of the book ends the same way it started, with the development of a small toy package. The whole game chapter established the basic mechanics, workflow, and tooling of package...">
<meta name="twitter:image" content="https://r-pkgs.org/images/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141182576-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-141182576-1');
  </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R Packages</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome!</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li class="book-part">Getting started</li>
<li><a class="" href="intro.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="whole-game.html"><span class="header-section-number">2</span> The whole game</a></li>
<li><a class="" href="setup.html"><span class="header-section-number">3</span> System setup</a></li>
<li><a class="" href="package-structure-state.html"><span class="header-section-number">4</span> Package structure and state</a></li>
<li><a class="" href="workflows101.html"><span class="header-section-number">5</span> Fundamental development workflows</a></li>
<li><a class="active" href="package-within.html"><span class="header-section-number">6</span> The package within</a></li>
<li class="book-part">Package components</li>
<li><a class="" href="r.html"><span class="header-section-number">7</span> R code</a></li>
<li><a class="" href="description.html"><span class="header-section-number">8</span> Package metadata</a></li>
<li><a class="" href="license.html"><span class="header-section-number">9</span> Licensing</a></li>
<li><a class="" href="man.html"><span class="header-section-number">10</span> Object documentation</a></li>
<li><a class="" href="vignettes.html"><span class="header-section-number">11</span> Vignettes: long-form documentation</a></li>
<li><a class="" href="tests.html"><span class="header-section-number">12</span> Testing</a></li>
<li><a class="" href="namespace.html"><span class="header-section-number">13</span> Namespace</a></li>
<li><a class="" href="data.html"><span class="header-section-number">14</span> External data</a></li>
<li><a class="" href="src.html"><span class="header-section-number">15</span> Compiled code</a></li>
<li><a class="" href="inst.html"><span class="header-section-number">16</span> Installed files</a></li>
<li><a class="" href="misc.html"><span class="header-section-number">17</span> Other components</a></li>
<li class="book-part">Sharing with others</li>
<li><a class="" href="git.html"><span class="header-section-number">18</span> Git and GitHub</a></li>
<li><a class="" href="r-cmd-check.html"><span class="header-section-number">19</span> Automated checking</a></li>
<li><a class="" href="release.html"><span class="header-section-number">20</span> Releasing a package</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/r-pkgs">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="package-within" class="section level1">
<h1>
<span class="header-section-number">6</span> The package within<a class="anchor" aria-label="anchor" href="#package-within"><i class="fas fa-link"></i></a>
</h1>
<p>This part of the book ends the same way it started, with the development of a small toy package.
The <a href="whole-game.html#whole-game">whole game chapter</a> established the basic mechanics, workflow, and tooling of package development, but said practically nothing about the R code inside the package.
Here we have a totally different emphasis.
In this chapter, we focus primarily on the package’s R code and how it differs from R code in a script.</p>
<p>We start with a data analysis script and show how to find the package that lurks within.
We isolate and then extract reusable data and logic from the script, put this into an R package, and then use that package in a much simplified script.
We make a few rookie mistakes along the way, in order to highlight special considerations for the R code inside a package.</p>
<p><em>The section headers incorporate the NATO phonetic alphabet and have no specific meaning.
They are just a convenient way to mark our progress towards a working package.</em></p>
<div id="alfa-a-script-that-works" class="section level2">
<h2>
<span class="header-section-number">6.1</span> Alfa: a script that works<a class="anchor" aria-label="anchor" href="#alfa-a-script-that-works"><i class="fas fa-link"></i></a>
</h2>
<p>Here is a fictional data analysis script <code>data-cleaning.R</code> for a group that collects reports from people who went for a swim:</p>
<blockquote>
<p>Where did you swim and how hot was it outside?</p>
</blockquote>
<p>Their data usually comes as a CSV file, which they read into a data frame.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">infile</span> <span class="op">&lt;-</span> <span class="st">"swim.csv"</span>
<span class="op">(</span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="va">infile</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;   name    where temp</span>
<span class="co">#&gt; 1 Adam    beach   95</span>
<span class="co">#&gt; 2 Bess    coast   91</span>
<span class="co">#&gt; 3 Cora seashore   28</span>
<span class="co">#&gt; 4 Dale    beach   85</span>
<span class="co">#&gt; 5 Evan  seaside   31</span></code></pre></div>
<p>They then classify each observation as using American (“US”) or British (“UK”) English, based on the word chosen to describe the sandy place where the ocean and land meet.
The <code>where</code> column is used to build the new <code>english</code> column.</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">$</span><span class="va">english</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">where</span> <span class="op">==</span> <span class="st">"beach"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"US"</span>
<span class="va">dat</span><span class="op">$</span><span class="va">english</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">where</span> <span class="op">==</span> <span class="st">"coast"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"US"</span>
<span class="va">dat</span><span class="op">$</span><span class="va">english</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">where</span> <span class="op">==</span> <span class="st">"seashore"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"UK"</span>
<span class="va">dat</span><span class="op">$</span><span class="va">english</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">where</span> <span class="op">==</span> <span class="st">"seaside"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"UK"</span></code></pre></div>
<p>Sadly, the temperatures are often reported in a mix of Fahrenheit and Celsius.
In the absence of better information, they guess that Americans report temperatures in Fahrenheit and therefore those observations are converted to Celsius.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span><span class="op">$</span><span class="va">temp</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">english</span> <span class="op">==</span> <span class="st">"US"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">temp</span><span class="op">[</span><span class="va">dat</span><span class="op">$</span><span class="va">english</span> <span class="op">==</span> <span class="st">"US"</span><span class="op">]</span> <span class="op">-</span> <span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">/</span><span class="fl">9</span>
<span class="va">dat</span>
<span class="co">#&gt;   name    where temp english</span>
<span class="co">#&gt; 1 Adam    beach 35.0      US</span>
<span class="co">#&gt; 2 Bess    coast 32.8      US</span>
<span class="co">#&gt; 3 Cora seashore 28.0      UK</span>
<span class="co">#&gt; 4 Dale    beach 29.4      US</span>
<span class="co">#&gt; 5 Evan  seaside 31.0      UK</span></code></pre></div>
<p>Finally, this cleaned (cleaner?) data is written back out to a CSV file.
They like to capture a timestamp in the filename when they do this<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;code&gt;Sys.time()&lt;/code&gt; returns an object of class &lt;code&gt;POSIXct&lt;/code&gt;, therefore when we call &lt;code&gt;format()&lt;/code&gt; on it, we are actually using &lt;code&gt;format.POSIXct()&lt;/code&gt;. Read the help for &lt;a href="https://rdrr.io/r/base/strptime.html"&gt;&lt;code&gt;?format.POSIXct&lt;/code&gt;&lt;/a&gt; if you’re not familiar with such format strings.&lt;/p&gt;'><sup>7</sup></a>.</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">now</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span>
<span class="op">(</span><span class="va">outfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">timestamp</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span>, <span class="va">infile</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] "2022-May-22_07-14-00_swim_clean.csv"</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">dat</span>, file <span class="op">=</span> <span class="va">outfile</span>, quote <span class="op">=</span> <span class="cn">FALSE</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Even if your typical analytical tasks are quite different, hopefully you see a few familiar patterns here.
It’s easy to imagine that this group does very similar pre-processing of many similar data files over time.
Their analyses can be more efficient and consistent if they make these standard data maneuvers available to themselves as functions in a package, instead of inlining the same data and logic into dozens or hundreds of data ingest scripts.</p>
</div>
<div id="bravo-a-better-script-that-works" class="section level2">
<h2>
<span class="header-section-number">6.2</span> Bravo: a better script that works<a class="anchor" aria-label="anchor" href="#bravo-a-better-script-that-works"><i class="fas fa-link"></i></a>
</h2>
<p>The package that lurks within the original script is actually pretty hard to see!
It’s obscured by a few suboptimal coding practices, such as the use of repetitive copy/paste-style code and the mixing of code and data.
Therefore a good first step is to refactor this code, isolating as much data and logic as possible in proper objects and functions, respectively.</p>
<p>At the same time, we introduce the use of some add-on packages, for several reasons.
First, we would actually use the tidyverse for this sort of data wrangling.
Second, many people use add-on packages in their scripts, so it is good to see how add-on packages are handled as we create this package.</p>
<p>Here’s the next version of the script.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">infile</span> <span class="op">&lt;-</span> <span class="st">"swim.csv"</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="va">infile</span>, col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"c"</span>, where <span class="op">=</span> <span class="st">"c"</span>, temp <span class="op">=</span> <span class="st">"d"</span><span class="op">)</span><span class="op">)</span>

<span class="va">lookup_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span>
      <span class="op">~</span><span class="va">where</span>, <span class="op">~</span><span class="va">english</span>,
     <span class="st">"beach"</span>,     <span class="st">"US"</span>,
     <span class="st">"coast"</span>,     <span class="st">"US"</span>,
  <span class="st">"seashore"</span>,     <span class="st">"UK"</span>,
   <span class="st">"seaside"</span>,     <span class="st">"UK"</span>
<span class="op">)</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">lookup_table</span><span class="op">)</span>
<span class="co">#&gt; Joining, by = "where"</span>

<span class="va">f_to_c</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">/</span><span class="fl">9</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>temp <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">english</span> <span class="op">==</span> <span class="st">"US"</span>, <span class="fu">f_to_c</span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, <span class="va">temp</span><span class="op">)</span><span class="op">)</span>
<span class="va">dat</span>
<span class="co">#&gt; <span style="color: #555555;"># A tibble: 5 × 4</span></span>
<span class="co">#&gt;   name  where     temp english</span>
<span class="co">#&gt;   <span style="color: #555555; font-style: italic;">&lt;chr&gt;</span> <span style="color: #555555; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #555555; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #555555; font-style: italic;">&lt;chr&gt;</span>  </span>
<span class="co">#&gt; <span style="color: #555555;">1</span> Adam  beach     35   US     </span>
<span class="co">#&gt; <span style="color: #555555;">2</span> Bess  coast     32.8 US     </span>
<span class="co">#&gt; <span style="color: #555555;">3</span> Cora  seashore  28   UK     </span>
<span class="co">#&gt; <span style="color: #555555;">4</span> Dale  beach     29.4 US     </span>
<span class="co">#&gt; <span style="color: #555555;">5</span> Evan  seaside   31   UK</span>

<span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">time</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span>
<span class="va">outfile_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/savehistory.html">timestamp</a></span><span class="op">(</span><span class="va">now</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span>, <span class="va">infile</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu">outfile_path</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The key features to note are:</p>
<ul>
<li>We are using functions from tidyverse packages (specifically from readr and
dplyr).</li>
<li>The map between different “beach” words and whether they are considered to be
US or UK English is now isolated in a lookup table, which lets us create
the <code>english</code> column in one go with a <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>. This also makes it
easier to add new words in the future</li>
<li>The <code>f_to_c()</code>, <code><a href="https://rdrr.io/r/utils/savehistory.html">timestamp()</a></code>, and <code>outfile_path()</code> functions now hold the
logic for converting temperatures and forming the timestamped output file
name.</li>
</ul>
<p>It’s getting easier to recognize the reusable bits of this script, i.e. the bits that have nothing to do with a specific input file, like <code>swim.csv</code>.
This sort of refactoring often happens naturally on the way to creating your own package, but if it does not, it’s a good idea to do this intentionally.</p>
</div>
<div id="charlie-external-helpers" class="section level2">
<h2>
<span class="header-section-number">6.3</span> Charlie: external helpers<a class="anchor" aria-label="anchor" href="#charlie-external-helpers"><i class="fas fa-link"></i></a>
</h2>
<p>A typical next step is to move reusable data and logic out of the analysis script and into one or more separate files.
This is a conventional opening move, if you want to use these same helper files in multiple analyses.</p>
<p>Here is the content of <code>beach-lookup-table.csv</code>:</p>
<pre><code>where,english
beach,US
coast,US
seashore,UK
seaside,UK</code></pre>
<p>Here is the content of <code>cleaning-helpers.R</code>:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">localize_beach</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">lookup_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span>
    <span class="st">"beach-lookup-table.csv"</span>,
    col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span>where <span class="op">=</span> <span class="st">"c"</span>, english <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">lookup_table</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">f_to_c</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">/</span><span class="fl">9</span>

<span class="va">celsify_temp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">dat</span>, temp <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">english</span> <span class="op">==</span> <span class="st">"US"</span>, <span class="fu">f_to_c</span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, <span class="va">temp</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">time</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span>
<span class="va">outfile_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/savehistory.html">timestamp</a></span><span class="op">(</span><span class="va">now</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span>, <span class="va">infile</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We’ve added some high-level helper functions, <code>localize_beach()</code> and <code>celsify_temp()</code>, to the pre-existing helpers (<code>f_to_c()</code>, <code><a href="https://rdrr.io/r/utils/savehistory.html">timestamp()</a></code>, and <code>outfile_path()</code>).</p>
<p>Here is the next version of the data cleaning script, now that we’ve pulled out the helper functions (and lookup table).</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"cleaning-helpers.R"</span><span class="op">)</span>

<span class="va">infile</span> <span class="op">&lt;-</span> <span class="st">"swim.csv"</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="va">infile</span>, col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"c"</span>, where <span class="op">=</span> <span class="st">"c"</span>, temp <span class="op">=</span> <span class="st">"d"</span><span class="op">)</span><span class="op">)</span>

<span class="op">(</span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu">localize_beach</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
    <span class="fu">celsify_temp</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Joining, by = "where"</span>
<span class="co">#&gt; <span style="color: #555555;"># A tibble: 5 × 4</span></span>
<span class="co">#&gt;   name  where     temp english</span>
<span class="co">#&gt;   <span style="color: #555555; font-style: italic;">&lt;chr&gt;</span> <span style="color: #555555; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #555555; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #555555; font-style: italic;">&lt;chr&gt;</span>  </span>
<span class="co">#&gt; <span style="color: #555555;">1</span> Adam  beach     35   US     </span>
<span class="co">#&gt; <span style="color: #555555;">2</span> Bess  coast     32.8 US     </span>
<span class="co">#&gt; <span style="color: #555555;">3</span> Cora  seashore  28   UK     </span>
<span class="co">#&gt; <span style="color: #555555;">4</span> Dale  beach     29.4 US     </span>
<span class="co">#&gt; <span style="color: #555555;">5</span> Evan  seaside   31   UK</span>

<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu">outfile_path</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>You’ll notice that the script is getting shorter and, hopefully, easier to read and modify, because repetitive and fussy clutter has been moved out of sight.
Whether the code is actually easier to work with is subjective and depends on how natural the “interface” feels for the people who actually preprocess swimming data.
These sorts of design decisions are the subject of a separate project: <a href="https://principles.tidyverse.org">principles.tidyverse.org</a>.</p>
<p>Let’s assume the group agrees that our design decisions are promising, i.e. we seem to be making things better, not worse.
Sure, the existing code is not perfect, but this is a typical developmental stage when you’re trying to figure out what the helper functions should be and how they should work.</p>
</div>
<div id="delta-an-attempt-at-a-package" class="section level2">
<h2>
<span class="header-section-number">6.4</span> Delta: an attempt at a package<a class="anchor" aria-label="anchor" href="#delta-an-attempt-at-a-package"><i class="fas fa-link"></i></a>
</h2>
<p>Let’s make a package! Here’s the simplest thing you might hope will “just work”: make <code>cleaning-helpers.R</code> into an R package. Somehow.</p>
<p>Concretely, we do this:</p>
<ul>
<li>Use <code><a href="https://usethis.r-lib.org/reference/create_package.html">usethis::create_package()</a></code> to scaffold a new R package.
<ul>
<li>This is a good first step!</li>
</ul>
</li>
<li>Copy <code>cleaning-helpers.R</code> into the new package, specifically, to
<code>R/cleaning-helpers.R</code>.
<ul>
<li>This is morally correct, but mechanically wrong in several ways, as we
will soon see.</li>
</ul>
</li>
<li>Copy <code>beach-lookup-table.csv</code> into the new package. But where? Let’s try
the top-level of the source package.
<ul>
<li>This is not going to end well. Shipping data in a package is a special
topic, which is covered in chapter <a href="data.html#data">14</a>.</li>
</ul>
</li>
<li>Install this package.
<ul>
<li>Despite all of the problems identified above, this actually works! Which
is interesting, because we can (try to) use it and see what happens.</li>
</ul>
</li>
</ul>
<p>Here’s the version of the script that you hope will run after successfully installing this package.</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">delta</span><span class="op">)</span>

<span class="va">infile</span> <span class="op">&lt;-</span> <span class="st">"swim.csv"</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="va">infile</span>, col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"c"</span>, where <span class="op">=</span> <span class="st">"c"</span>, temp <span class="op">=</span> <span class="st">"d"</span><span class="op">)</span><span class="op">)</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">localize_beach</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">celsify_temp</span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu">outfile_path</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The only change from our previous script is that</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"cleaning-helpers.R"</span><span class="op">)</span></code></pre></div>
<p>has been replaced by</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">delta</span><span class="op">)</span></code></pre></div>
<p>Here’s what actually happens when we try to run this:</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">delta</span><span class="op">)</span>

<span class="va">infile</span> <span class="op">&lt;-</span> <span class="st">"swim.csv"</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="va">infile</span>, col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"c"</span>, where <span class="op">=</span> <span class="st">"c"</span>, temp <span class="op">=</span> <span class="st">"d"</span><span class="op">)</span><span class="op">)</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">localize_beach</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">celsify_temp</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error in localize_beach(.) : could not find function "localize_beach"</span>

<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu">outfile_path</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Error in outfile_path(infile) : could not find function "outfile_path"</span></code></pre></div>
<p>None of our helper functions are actually available for use, even though we call <code><a href="https://rdrr.io/r/base/library.html">library(delta)</a></code>!
In contrast to <code><a href="https://rdrr.io/r/base/source.html">source()</a></code>ing a file of helper functions, attaching a package does not dump its functions into the global workspace.
By default, functions in a package are only for internal use.
We need to export <code>localize_beach()</code>, <code>celsify_temp()</code>, and <code>outfile_path()</code> so our users can call them.
In this book, we achieve this by putting <code>@export</code> in the special roxygen comment above each function (namespace management is covered in chapter <a href="namespace.html#namespace">13</a>).</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' @export</span>
<span class="va">celsify_temp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">dat</span>, temp <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">english</span> <span class="op">==</span> <span class="st">"US"</span>, <span class="fu">f_to_c</span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, <span class="va">temp</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Let’s say we do that, run <code><a href="https://devtools.r-lib.org/reference/document.html">devtools::document()</a></code> to (re)generate a <code>NAMESPACE</code> file, and re-install the package.
Now when we execute our script, it works!</p>
<p>Correction: it works <em>sometimes</em>.
Specifically, it works if and only if the working directory is set to the top-level of the source package.
From any other working directory, we still get an error:</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">delta</span><span class="op">)</span>

<span class="va">infile</span> <span class="op">&lt;-</span> <span class="st">"swim.csv"</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="va">infile</span>, col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"c"</span>, where <span class="op">=</span> <span class="st">"c"</span>, temp <span class="op">=</span> <span class="st">"d"</span><span class="op">)</span><span class="op">)</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">localize_beach</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">celsify_temp</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Error: 'beach-lookup-table.csv' does not exist in current working directory ('/Users/jenny/tmp').</span>

<span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu">outfile_path</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The lookup table consulted inside <code>localize_beach()</code> cannot be found.
One does not simply dump CSV files into the source of an R package and expect things to “just work”.
We will fix this in our next iteration of the package (chapter <a href="data.html#data">14</a> has full coverage of how to include data in a package).</p>
<p>Before we abandon this initial experiment, let’s also marvel at the fact that we were able to install, attach, and, to a certain extent, use a fundamentally broken package.
<code><a href="https://devtools.r-lib.org/reference/load_all.html">load_all()</a></code> works fine, too!
This is a sobering reminder that you should be running <code>R CMD check</code>, probably via <code><a href="https://devtools.r-lib.org/reference/check.html">check()</a></code>, very often during development.
This will quickly alert you to many problems that simple installation and usage does not reveal.</p>
<p>Indeed, <code>R CMD check</code> fails for this package and we see this<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;If you have not done so already, you’ll also need to configure a license to satisfy &lt;code&gt;R CMD check&lt;/code&gt;.
For a quick experiment like this, &lt;code&gt;usethis::use_mit_license()&lt;/code&gt; is fine.
For real work, see chapter &lt;a href="license.html#license"&gt;9&lt;/a&gt; for guidance.&lt;/p&gt;'><sup>8</sup></a>:</p>
<pre><code>* installing *source* package ‘delta’ ...
** using staged installation
** R
** byte-compile and prepare package for lazy loading
Error in library(tidyverse) : there is no package called ‘tidyverse’
Error: unable to load R code in package ‘delta’
Execution halted
ERROR: lazy loading failed for package ‘delta’
* removing ‘/Users/jenny/rrr/delta.Rcheck/delta’</code></pre>
<p>What do you mean “there is no package called ‘tidyverse’”?!?
We’re using it, with no problems, in our main script!
Also, we’ve already installed and used this package, why can’t <code>R CMD check</code> install it?</p>
<p>This error is what happens when the strictness of <code>R CMD check</code> meets the very first line of <code>R/cleaning-helpers.R</code>:</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></code></pre></div>
<p>This is <strong>not</strong> how you declare that your package depends on another package (the tidyverse, in this case).
This is <strong>not</strong> how you make functions in another package available for use in yours.
Dependencies must be declared in <code>DESCRIPTION</code> (and that’s not all).
Since we declared no dependencies, <code>R CMD check</code> takes us at our word and tries to install our package with only the base packages available, which means this <code><a href="https://tidyverse.tidyverse.org">library(tidyverse)</a></code> call fails.
A “regular” installation succeeds, simply because the tidyverse is available in your regular library, which hides this particular mistake.</p>
<p>To review, copying <code>cleaning-helpers.R</code> to <code>R/cleaning-helpers.R</code>, without further modification, was problematic in (at least) these ways:</p>
<ul>
<li>Does not account for exported vs. non-exported functions.</li>
<li>The CSV file holding our lookup table cannot be found in the installed
package.</li>
<li>Does not properly declare our dependency on other add-on packages.</li>
</ul>
</div>
<div id="echo-a-working-package" class="section level2">
<h2>
<span class="header-section-number">6.5</span> Echo: a working package<a class="anchor" aria-label="anchor" href="#echo-a-working-package"><i class="fas fa-link"></i></a>
</h2>
<p>We’re ready to make the most minimal version of this package that actually works.</p>
<p>Here is the new version of <code>R/cleaning-helpers.R</code><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Putting everything in one file, with this name, is not ideal, but it is technically allowed.
We discuss organising and naming the files below &lt;code&gt;R/&lt;/code&gt; in section &lt;a href="r.html#code-organising"&gt;7.1&lt;/a&gt;.&lt;/p&gt;'><sup>9</sup></a>:</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lookup_table</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span>
      <span class="op">~</span><span class="va">where</span>, <span class="op">~</span><span class="va">english</span>,
     <span class="st">"beach"</span>,     <span class="st">"US"</span>,
     <span class="st">"coast"</span>,     <span class="st">"US"</span>,
  <span class="st">"seashore"</span>,     <span class="st">"UK"</span>,
   <span class="st">"seaside"</span>,     <span class="st">"UK"</span>
<span class="op">)</span>

<span class="co">#' @export</span>
<span class="va">localize_beach</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">lookup_table</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">f_to_c</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">32</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">/</span><span class="fl">9</span>

<span class="co">#' @export</span>
<span class="va">celsify_temp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">dat</span>, temp <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">english</span> <span class="op">==</span> <span class="st">"US"</span>, <span class="fu">f_to_c</span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, <span class="va">temp</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">time</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span>

<span class="co">#' @export</span>
<span class="va">outfile_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/savehistory.html">timestamp</a></span><span class="op">(</span><span class="va">now</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span>, <span class="va">infile</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We’ve gone back to defining the <code>lookup_table</code> with R code, since our initial attempt to read it from CSV created some sort of filepath snafu.
This is OK for small, internal, static data, but remember to see chapter <a href="data.html#data">14</a> for more general techniques for storing data in a package.</p>
<p>All of our calls to tidyverse functions have now been qualified with the name of the specific package that actually provides the function, e.g. <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code>.
There are other ways to access functions in another package, explained in chapter <a href="namespace.html#namespace">13</a>, but this is our recommended default.
It is also our strong recommendation that no one depend on the tidyverse meta-package in a package<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;The blog post &lt;a href="https://www.tidyverse.org/blog/2018/06/tidyverse-not-for-packages/"&gt;The tidyverse is for EDA, not packages&lt;/a&gt; elaborates on this.&lt;/p&gt;'><sup>10</sup></a>.
Instead, it is better to identify the specific package(s) you actually use.
In this case, our package only uses dplyr.</p>
<p>The <code><a href="https://tidyverse.tidyverse.org">library(tidyverse)</a></code> call is gone and instead we declare our use of dplyr in the Imports field of <code>DESCRIPTION</code>:</p>
<pre><code>Package: echo
(... other lines omitted ...)
Imports: 
    dplyr</code></pre>
<p>This, together with our use of namespace-qualified calls, like <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::left_join()</a></code>, constitutes a valid way to use another package within ours.
The metadata conveyed via DESCRIPTION is covered in chapter <a href="description.html#description">8</a>.</p>
<p>All of the user-facing functions have an <code>@export</code> tag in their roxygen comment, which means that <code><a href="https://devtools.r-lib.org/reference/document.html">devtools::document()</a></code> adds them correctly to the <code>NAMESPACE</code> file.
Note that <code>f_to_c()</code> is currently only used internally, inside <code>celsify_temp()</code>, so we have not exported it (likewise for <code><a href="https://rdrr.io/r/utils/savehistory.html">timestamp()</a></code>).</p>
<p>This version of the package can be installed, used, AND it technically passes <code>R CMD check</code>, though with 1 note and 1 warning.</p>
<pre><code>* checking R code for possible problems ... NOTE
celsify_temp: no visible binding for global variable ‘english’
celsify_temp: no visible binding for global variable ‘temp’
Undefined global functions or variables:
  english temp

* checking for missing documentation entries ... WARNING
Undocumented code objects:
  ‘celsify_temp’ ‘localize_beach’ ‘outfile_path’
All user-level objects in a package should have documentation entries.
See chapter ‘Writing R documentation files’ in the ‘Writing R
Extensions’ manual.</code></pre>
<p>The “no visible binding” note is a peculiarity of using dplyr and unquoted variable names inside a package, where the use of bare variable names (<code>english</code> and <code>temp</code>) looks suspicious.
We could add either of these lines to any file below <code>R/</code> to eliminate this note<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;For more details, see the &lt;a href="https://dplyr.tidyverse.org/articles/programming.html#eliminating-r-cmd-check-notes"&gt;Programming with dplyr vignette&lt;/a&gt;.&lt;/p&gt;'><sup>11</sup></a>:</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># option 1 (then you should also put utils in Imports)</span>
<span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/globalVariables.html">globalVariables</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"english"</span>, <span class="st">"temp"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># option 2</span>
<span class="va">english</span> <span class="op">&lt;-</span> <span class="va">temp</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></code></pre></div>
<p>The warning about missing documentation is because we haven’t properly documented our exported functions.
This is a valid concern and something you should absolutely address in a real package.
You’ve already seen how to create help files with roxygen comments in <a href="whole-game-document">the whole game chapter</a> and we cover this topic thoroughly in chapter <a href="man.html#man">10</a>.
Therefore, we won’t discuss this further here.</p>
</div>
<div id="package-within-build-time-run-time" class="section level2">
<h2>
<span class="header-section-number">6.6</span> Foxtrot: build time vs. run time<a class="anchor" aria-label="anchor" href="#package-within-build-time-run-time"><i class="fas fa-link"></i></a>
</h2>
<p>The package works, which is great, but group members notice something odd about the timestamps:</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "2022-02-24 20:49:59 PST"</span>

<span class="fu">outfile_path</span><span class="op">(</span><span class="st">"INFILE.csv"</span><span class="op">)</span>
<span class="co">#&gt; [1] "2020-September-03_11-06-33_INFILE_clean.csv"</span></code></pre></div>
<p>The datetime in the timestamped filename doesn’t reflect the time reported by the system.
In fact, the users claim that the timestamp never seems to change at all!
Why is this?</p>
<p>Recall how we form the filepath for output files:</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">time</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span>
<span class="va">outfile_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/savehistory.html">timestamp</a></span><span class="op">(</span><span class="va">now</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span>, <span class="va">infile</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The fact that we capture <code>now &lt;- Sys.time()</code> outside of the definition of <code>outfile_path()</code> has probably been vexing some readers for a while.
<code>now</code> reflects the instant in time when we execute <code>now &lt;- Sys.time()</code>.
In the initial approach, that happened when we <code><a href="https://rdrr.io/r/base/source.html">source()</a></code>d <code>cleaning-helpers.R</code>.
That’s not ideal, but it was probably a pretty harmless mistake, because the helper file would be <code><a href="https://rdrr.io/r/base/source.html">source()</a></code>d shortly before we wrote the outfile.</p>
<p>But this approach is quite devastating in the context of a package.
<code>now &lt;- Sys.time()</code> is executed <strong>when the package is built</strong>.
And never again.
It is very easy to subconsciously assume your package code is re-evaluated when the package is installed, attached, or used.
But it is not.
Yes, the code <em>inside your functions</em> is absolutely run whenever they are called.
But your functions – and any other objects created in top-level code below <code>R/</code> – are defined exactly once, at build time.</p>
<p>By defining <code>now</code> with top-level code below <code>R/</code>, we’ve doomed our package to timestamp all of its output files with the same (wrong) time.
The fix is to make sure the <code><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time()</a></code> call happens at runtime.</p>
<p>Let’s look again at parts of <code>R/cleaning-helpers.R</code>:</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lookup_table</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span>
      <span class="op">~</span><span class="va">where</span>, <span class="op">~</span><span class="va">english</span>,
     <span class="st">"beach"</span>,     <span class="st">"US"</span>,
     <span class="st">"coast"</span>,     <span class="st">"US"</span>,
  <span class="st">"seashore"</span>,     <span class="st">"UK"</span>,
   <span class="st">"seaside"</span>,     <span class="st">"UK"</span>
<span class="op">)</span>

<span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">time</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span>
<span class="va">outfile_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/savehistory.html">timestamp</a></span><span class="op">(</span><span class="va">now</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span>, <span class="va">infile</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>There are four top-level <code>&lt;-</code> assignments in this excerpt.
The top-level definitions of the data frame <code>lookup_table</code> and the functions <code><a href="https://rdrr.io/r/utils/savehistory.html">timestamp()</a></code> and <code>outfile_path()</code> are correct.
It is appropriate that these be defined exactly once, at build time.
The top-level definition of <code>now</code>, which is then used inside <code>outfile_path()</code>, is regrettable.</p>
<p>Here are better versions of <code>outfile_path()</code>:</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># always timestamp as "now"</span>
<span class="va">outfile_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">infile</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/savehistory.html">timestamp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">ts</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span>, <span class="va">infile</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># allow user to provide a time, but default to "now"</span>
<span class="va">outfile_path</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">infile</span>, <span class="va">time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/savehistory.html">timestamp</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">ts</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"(.*)([.]csv$)"</span>, <span class="st">"\\1_clean\\2"</span>, <span class="va">infile</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>This illustrates that you need to have a different mindset when defining objects inside a package.
The vast majority of those objects should be functions and these functions should generally only use data they create or that is passed via an argument.
There are some types of sloppiness that are fairly harmless when a function is defined immediately before its use, but that can be more costly for functions distributed as a package.</p>
</div>
<div id="package-within-side-effects" class="section level2">
<h2>
<span class="header-section-number">6.7</span> Golf: side effects<a class="anchor" aria-label="anchor" href="#package-within-side-effects"><i class="fas fa-link"></i></a>
</h2>
<p>The timestamps now reflect the current time, but the group raises a new concern.
As it stands, the timestamps reflect who has done the data cleaning and which part of the world they’re in.
The heart of the timestamp strategy is this format string<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;&lt;code&gt;Sys.time()&lt;/code&gt; returns an object of class &lt;code&gt;POSIXct&lt;/code&gt;, therefore when we call &lt;code&gt;format()&lt;/code&gt; on it, we are actually using &lt;code&gt;format.POSIXct()&lt;/code&gt;. Read the help for &lt;a href="https://rdrr.io/r/base/strptime.html"&gt;&lt;code&gt;?format.POSIXct&lt;/code&gt;&lt;/a&gt; if you’re not familiar with such format strings.&lt;/p&gt;'><sup>12</sup></a>:</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span>
<span class="co">#&gt; [1] "2022-May-22_07-14-02"</span></code></pre></div>
<p>This formats <code><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time()</a></code> in such a way that it includes the month <em>name</em> (not number) and the local time<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;It would clearly be better to format according to ISO 8601, which encodes the month by number, but please humor me for the sake of making this example more obvious.&lt;/p&gt;"><sup>13</sup></a>.</p>
<p>Here’s such a timestamp produced by a few hypothetical colleagues cleaning some data at exactly the same instant in time.</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left">location</th>
<th align="left">timestamp</th>
<th align="left">LC_TIME</th>
<th align="left">tz</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Rome, Italy</td>
<td align="left">2020-settembre-05_00-30-00</td>
<td align="left">it_IT.UTF-8</td>
<td align="left">Europe/Rome</td>
</tr>
<tr class="even">
<td align="left">Warsaw, Poland</td>
<td align="left">2020-września-05_00-30-00</td>
<td align="left">pl_PL.UTF-8</td>
<td align="left">Europe/Warsaw</td>
</tr>
<tr class="odd">
<td align="left">Sao Paulo, Brazil</td>
<td align="left">2020-setembro-04_19-30-00</td>
<td align="left">pt_BR.UTF-8</td>
<td align="left">America/Sao_Paulo</td>
</tr>
<tr class="even">
<td align="left">Greenwich, England</td>
<td align="left">2020-September-04_23-30-00</td>
<td align="left">en_GB.UTF-8</td>
<td align="left">Europe/London</td>
</tr>
<tr class="odd">
<td align="left">“Computer World!”</td>
<td align="left">2020-September-04_22-30-00</td>
<td align="left">C</td>
<td align="left">UTC</td>
</tr>
</tbody>
</table></div>
<p>We see that the month names vary, as does the time, and even the date!
The safest choice is to form timestamps with respect to a fixed locale and time zone (presumably the non-geographic choices represented by “Computer World!” above).</p>
<p>You do some research and learn that you can force a certain locale via <code><a href="https://rdrr.io/r/base/locales.html">Sys.setlocale()</a></code> and force a certain time zone by setting the TZ environment variable.
Specifically, we set the LC_TIME component of the locale to “C” and the time zone to “UTC” (Coordinated Universal Time).
Here’s your first attempt to improve <code><a href="https://rdrr.io/r/utils/savehistory.html">timestamp()</a></code>:</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/locales.html">Sys.setlocale</a></span><span class="op">(</span><span class="st">"LC_TIME"</span>, <span class="st">"C"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>TZ <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">time</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>But your Brazilian colleague notices that datetimes print differently, before and after she uses <code>outfile_path()</code> from your package:</p>
<p>Before:</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; [1] "2022-maio-22_04-14-02"</code></pre>
<p>After:</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">outfile_path</span><span class="op">(</span><span class="st">"INFILE.csv"</span><span class="op">)</span>
<span class="co">#&gt; [1] "2022-May-22_07-14-02_INFILE_clean.csv"</span>

<span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span>
<span class="co">#&gt; [1] "2022-May-22_07-14-02"</span></code></pre></div>
<p>Notice that her month name switched from Portuguese to English and the time is clearly being reported in a different time zone.
Our calls to <code><a href="https://rdrr.io/r/base/locales.html">Sys.setlocale()</a></code> and <code><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv()</a></code> inside <code><a href="https://rdrr.io/r/utils/savehistory.html">timestamp()</a></code> have made persistent (and very surprising) changes to her R session.
This sort of side effect is very undesirable and is extremely difficult to track down and debug, especially in more complicated settings.</p>
<p>Here are better versions of <code><a href="https://rdrr.io/r/utils/savehistory.html">timestamp()</a></code>:</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># use withr::local_*() functions to keep the changes local to timestamp()</span>
<span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_locale.html">local_locale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LC_TIME"</span> <span class="op">=</span> <span class="st">"C"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_timezone.html">local_timezone</a></span><span class="op">(</span><span class="st">"UTC"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">time</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># use the tz argument to format.POSIXct()</span>
<span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_locale.html">local_locale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LC_TIME"</span> <span class="op">=</span> <span class="st">"C"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">time</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># put the format() call inside withr::with_*()</span>
<span class="va">timestamp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_locale.html">with_locale</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LC_TIME"</span> <span class="op">=</span> <span class="st">"C"</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">time</span>, <span class="st">"%Y-%B-%d_%H-%M-%S"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We show various methods to limit the scope of our changes to LC_TIME and the timezone.
A good rule of thumb is to make the scope of such changes as narrow as is possible and practical.
The <code>tz</code> argument of <code><a href="https://rdrr.io/r/base/format.html">format()</a></code> is the most surgical way to deal with the timezone, but nothing similar exists for LC_TIME.
We make the temporary locale modification using the withr package, which provides a very flexible toolkit for temporary state changes.
This (and <code><a href="https://rdrr.io/r/base/on.exit.html">base::on.exit()</a></code>) are discussed further in section <a href="r.html#code-r-landscape">7.5</a>.</p>
<p>This underscores a point from the previous section: you need to adopt a different mindset when defining functions inside a package.
Try to avoid making any changes to the user’s overall state.
If such changes are unavoidable, make sure to reverse them (if possible) or to document them explicitly (if related to the function’s primary purpose).</p>
<!--

Loose ends and Unimplemented ideas

Inconsistent w.r.t. voice: is it "they" or "you" or "we" who's writing this package?

Another data cleaning idea was to deal with dysfunctional missing value codes, e.g. where -99 means temp is missing.

Could also show using the degree symbol properly with unicode escape sequence.

-->
<!--

Text to possible reuse?

As your use of R becomes more sophisticated, it's common to start to write your own R functions.
If a function is only used in one place, you probably define it right there.
But if you've bothered to write a function, it's likely you want to reuse it in multiple places: within one script, across multiple scripts, or even across multiple projects.
This is *exactly* what an R package is for!

Without package technology, you probably collect these function definitions in one or more dedicated `.R` files and then `source()` them as needed.
Typically these functions co-evolve with the code where you use them, i.e. your analysis code, your Shiny apps, or your R Markdown reports.
If you use these functions across multiple projects, you also face the uncomfortable dilemma of where to define them and whether to have multiple, slightly different copies of this code lying around.

-->

</div>
</div>




  <div class="chapter-nav">
<div class="prev"><a href="workflows101.html"><span class="header-section-number">5</span> Fundamental development workflows</a></div>
<div class="next"><a href="r.html"><span class="header-section-number">7</span> R code</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#package-within"><span class="header-section-number">6</span> The package within</a></li>
<li><a class="nav-link" href="#alfa-a-script-that-works"><span class="header-section-number">6.1</span> Alfa: a script that works</a></li>
<li><a class="nav-link" href="#bravo-a-better-script-that-works"><span class="header-section-number">6.2</span> Bravo: a better script that works</a></li>
<li><a class="nav-link" href="#charlie-external-helpers"><span class="header-section-number">6.3</span> Charlie: external helpers</a></li>
<li><a class="nav-link" href="#delta-an-attempt-at-a-package"><span class="header-section-number">6.4</span> Delta: an attempt at a package</a></li>
<li><a class="nav-link" href="#echo-a-working-package"><span class="header-section-number">6.5</span> Echo: a working package</a></li>
<li><a class="nav-link" href="#package-within-build-time-run-time"><span class="header-section-number">6.6</span> Foxtrot: build time vs. run time</a></li>
<li><a class="nav-link" href="#package-within-side-effects"><span class="header-section-number">6.7</span> Golf: side effects</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/r-pkgs/blob/main/Package-within.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/r-pkgs/edit/main/Package-within.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R Packages</strong>" was written by Hadley Wickham, Jennifer Bryan. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
